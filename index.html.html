<!doctype html>
<html lang="de">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Team-Checkliste (Live)</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="min-h-screen bg-gray-50">
    <main class="mx-auto max-w-5xl p-6">
      <header class="mb-6 flex flex-col gap-2 md:flex-row md:items-end md:justify-between">
        <div>
          <h1 class="text-2xl font-bold">Team-Checkliste (Live)</h1>
          <p class="text-sm text-gray-600">Jede √Ñnderung ist f√ºr alle sofort sichtbar (Firebase + anonyme Anmeldung).</p>
        </div>
        <div class="flex items-center gap-2 text-sm text-gray-700">
          <label class="flex items-center gap-2"><input id="toggleCompleted" type="checkbox" checked> Erledigte anzeigen</label>
          <input id="search" placeholder="Suchen‚Ä¶" class="w-56 rounded-xl border border-gray-300 bg-white px-3 py-2 text-sm shadow-sm focus:border-black focus:outline-none" />
        </div>
      </header>

      <!-- Add Category -->
      <section class="mb-6 grid gap-3 rounded-2xl border border-gray-200 bg-white p-4 shadow-sm md:grid-cols-3">
        <div class="md:col-span-2">
          <label class="mb-1 block text-sm font-medium">Neue Kategorie</label>
          <input id="newCat" placeholder="z.‚ÄØB. Drogenverkauf / Battlepass" class="w-full rounded-xl border border-gray-300 bg-white px-3 py-2 text-sm shadow-sm focus:border-black focus:outline-none" />
        </div>
        <div class="flex items-end">
          <button id="addCatBtn" class="w-full rounded-2xl bg-black px-4 py-2 text-sm font-semibold text-white shadow-sm hover:opacity-90">Kategorie hinzuf√ºgen</button>
        </div>
      </section>

      <!-- Add Task -->
      <section class="mb-8 grid gap-3 rounded-2xl border border-gray-200 bg-white p-4 shadow-sm md:grid-cols-4">
        <div>
          <label class="mb-1 block text-sm font-medium">Kategorie w√§hlen</label>
          <select id="catSelect" class="w-full rounded-xl border border-gray-300 bg-white px-3 py-2 text-sm shadow-sm focus:border-black focus:outline-none">
            <option value="">‚Äî</option>
          </select>
        </div>
        <div class="md:col-span-2">
          <label class="mb-1 block text-sm font-medium">Neuer Task</label>
          <input id="newTask" placeholder="Kurzer Titel (z.‚ÄØB. ‚ÄòDispatch konfigurieren‚Äô)" class="w-full rounded-xl border border-gray-300 bg-white px-3 py-2 text-sm shadow-sm focus:border-black focus:outline-none" />
        </div>
        <div class="md:col-span-3">
          <label class="mb-1 block text-sm font-medium">Notiz (optional)</label>
          <textarea id="newNote" placeholder="Details, Links, Akzeptanzkriterien‚Ä¶" class="h-20 w-full rounded-xl border border-gray-300 bg-white px-3 py-2 text-sm shadow-sm focus:border-black focus:outline-none"></textarea>
        </div>
        <div class="flex items-end">
          <button id="addTaskBtn" class="w-full rounded-2xl bg-black px-4 py-2 text-sm font-semibold text-white shadow-sm hover:opacity-90">Task hinzuf√ºgen</button>
        </div>
      </section>

      <!-- List -->
      <section id="list" class="grid gap-6"></section>

      <footer class="mt-10 text-xs text-gray-500">
        <p>üí° Diese Seite ist statisch und kann kostenlos z.‚ÄØB. bei Netlify, Vercel oder GitHub Pages gehostet werden.</p>
      </footer>
    </main>

    <script type="module">
      // ---- 1) Firebase-Konfiguration (ersetzen) ----
      const firebaseConfig = {
        apiKey: "REPLACE_ME",
        authDomain: "REPLACE_ME.firebaseapp.com",
        projectId: "REPLACE_ME",
        storageBucket: "REPLACE_ME.appspot.com",
        messagingSenderId: "REPLACE_ME",
        appId: "REPLACE_ME",
      };

      // ---- 2) SDK Imports ----
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
      import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";
      import {
        getFirestore, collection, addDoc, doc, setDoc, updateDoc, deleteDoc,
        serverTimestamp, query, orderBy, onSnapshot, getDocs
      } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";

      // ---- 3) Init ----
      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);
      await signInAnonymously(auth);

      // ---- 4) DOM refs ----
      const listEl = document.getElementById('list');
      const newCatEl = document.getElementById('newCat');
      const addCatBtn = document.getElementById('addCatBtn');
      const catSelectEl = document.getElementById('catSelect');
      const newTaskEl = document.getElementById('newTask');
      const newNoteEl = document.getElementById('newNote');
      const addTaskBtn = document.getElementById('addTaskBtn');
      const searchEl = document.getElementById('search');
      const toggleCompletedEl = document.getElementById('toggleCompleted');

      // ---- 5) Firestore Collections ----
      const CATS = collection(db, 'categories');
      const TASKS = collection(db, 'tasks');

      // ---- 6) Realtime listeners ----
      let categories = [];
      let tasks = [];

      const catsQ = query(CATS, orderBy('createdAt', 'desc'));
      const tasksQ = query(TASKS, orderBy('createdAt', 'desc'));

      onSnapshot(catsQ, (snap) => {
        categories = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        renderCatsSelect();
        render();
      });
      onSnapshot(tasksQ, (snap) => {
        tasks = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        render();
      });

      // ---- 7) Actions ----
      addCatBtn.addEventListener('click', async () => {
        const name = newCatEl.value.trim();
        if (!name) return;
        await addDoc(CATS, { name, createdAt: serverTimestamp() });
        newCatEl.value = '';
      });

      addTaskBtn.addEventListener('click', async () => {
        const catId = catSelectEl.value;
        const title = newTaskEl.value.trim();
        const note = newNoteEl.value.trim();
        if (!catId || !title) return;
        await addDoc(TASKS, { catId, title, note, done: false, createdAt: serverTimestamp() });
        newTaskEl.value = '';
        newNoteEl.value = '';
      });

      searchEl.addEventListener('input', render);
      toggleCompletedEl.addEventListener('change', render);

      async function toggleDone(task) {
        const ref = doc(db, 'tasks', task.id);
        await updateDoc(ref, { done: !task.done });
      }
      async function deleteTask(task) {
        const ref = doc(db, 'tasks', task.id);
        await deleteDoc(ref);
      }
      async function renameCategory(cat, newName) {
        const ref = doc(db, 'categories', cat.id);
        await updateDoc(ref, { name: newName });
      }
      async function deleteCategory(cat) {
        // delete its tasks first
        const toDelete = tasks.filter(t => t.catId === cat.id);
        for (const t of toDelete) await deleteTask(t);
        await deleteDoc(doc(db, 'categories', cat.id));
      }

      // ---- 8) Rendering ----
      function renderCatsSelect() {
        catSelectEl.innerHTML = '<option value="">‚Äî</option>' + categories.map(c => `<option value="${c.id}">${escapeHtml(c.name)}</option>`).join('');
      }

      function render() {
        const q = searchEl.value.trim().toLowerCase();
        const showCompleted = toggleCompletedEl.checked;

        listEl.innerHTML = categories.map(c => {
          const items = tasks
            .filter(t => t.catId === c.id)
            .filter(t => (showCompleted ? true : !t.done))
            .filter(t => t.title.toLowerCase().includes(q) || (t.note||'').toLowerCase().includes(q));

          const rows = items.map(t => TaskRow(t)).join('') || EmptyRow();

          const doneCount = items.filter(x => x.done).length;
          return `
            <div class="rounded-2xl border border-gray-200 bg-white p-4 shadow-sm">
              <div class="mb-3 flex items-center justify-between gap-3">
                <div class="flex items-center gap-2">
                  <h2 class="text-lg font-semibold">${escapeHtml(c.name)}</h2>
                  <span class="rounded-full border border-gray-200 px-2 py-0.5 text-xs text-gray-600">${doneCount}/${items.length} erledigt</span>
                </div>
                <div class="flex items-center gap-2">
                  <button data-action="renameCat" data-id="${c.id}" class="rounded-xl border border-gray-300 bg-white px-3 py-2 text-xs font-semibold hover:bg-gray-50">Umbenennen</button>
                  <button data-action="clearDone" data-id="${c.id}" class="rounded-xl border border-gray-300 bg-white px-3 py-2 text-xs font-semibold hover:bg-gray-50">Erledigte l√∂schen</button>
                  <button data-action="deleteCat" data-id="${c.id}" class="rounded-xl bg-red-600 px-3 py-2 text-xs font-semibold text-white hover:opacity-90">Kategorie l√∂schen</button>
                </div>
              </div>
              <ul class="space-y-2" data-cat="${c.id}">${rows}</ul>
            </div>`;
        }).join('');

        // attach events for dynamic buttons
        listEl.querySelectorAll('[data-action="renameCat"]').forEach(btn => btn.addEventListener('click', async (e) => {
          const id = e.currentTarget.getAttribute('data-id');
          const cat = categories.find(x => x.id === id);
          const name = prompt('Neuer Kategoriename:', cat?.name ?? '');
          if (name && name.trim()) await renameCategory(cat, name.trim());
        }));
        listEl.querySelectorAll('[data-action="deleteCat"]').forEach(btn => btn.addEventListener('click', async (e) => {
          const id = e.currentTarget.getAttribute('data-id');
          const cat = categories.find(x => x.id === id);
          if (confirm('Kategorie inkl. Tasks l√∂schen?')) await deleteCategory(cat);
        }));
        listEl.querySelectorAll('[data-action="clearDone"]').forEach(btn => btn.addEventListener('click', async (e) => {
          const id = e.currentTarget.getAttribute('data-id');
          const items = tasks.filter(t => t.catId === id && t.done);
          for (const t of items) await deleteTask(t);
        }));

        listEl.querySelectorAll('input[data-toggle]').forEach(chk => chk.addEventListener('change', async (e) => {
          const id = e.currentTarget.getAttribute('data-toggle');
          const task = tasks.find(x => x.id === id);
          await toggleDone(task);
        }));

        listEl.querySelectorAll('button[data-edit]').forEach(btn => btn.addEventListener('click', async (e) => {
          const id = e.currentTarget.getAttribute('data-edit');
          const task = tasks.find(x => x.id === id);
          const newTitle = prompt('Titel bearbeiten:', task?.title ?? '');
          if (newTitle === null) return; // cancelled
          const newNote = prompt('Notiz bearbeiten:', task?.note ?? '');
          const ref = doc(db, 'tasks', id);
          await updateDoc(ref, { title: (newTitle||'').trim() || task.title, note: (newNote||'').trim() });
        }));

        listEl.querySelectorAll('button[data-del]').forEach(btn => btn.addEventListener('click', async (e) => {
          const id = e.currentTarget.getAttribute('data-del');
          const task = tasks.find(x => x.id === id);
          if (confirm('Task l√∂schen?')) await deleteTask(task);
        }));
      }

      function TaskRow(t) {
        return `
          <li class="flex items-start gap-3 rounded-xl border border-gray-200 p-3">
            <input type="checkbox" data-toggle="${t.id}" ${t.done ? 'checked' : ''} class="mt-1 h-5 w-5 rounded-xl border-gray-300" />
            <div class="flex-1">
              <div class="flex items-center justify-between gap-3">
                <p class="text-sm ${t.done ? 'line-through text-gray-400' : 'text-gray-800'}">${escapeHtml(t.title)}</p>
                <div class="flex gap-2">
                  <button data-edit="${t.id}" class="rounded-xl border border-gray-300 bg-white px-2 py-1 text-xs font-semibold hover:bg-gray-50">Bearbeiten</button>
                  <button data-del="${t.id}" class="rounded-xl bg-red-600 px-2 py-1 text-xs font-semibold text-white hover:opacity-90">L√∂schen</button>
                </div>
              </div>
              ${t.note ? `<p class="mt-1 text-xs text-gray-600">${escapeHtml(t.note)}</p>` : ''}
            </div>
          </li>`;
      }

      function EmptyRow() {
        return `<li class="rounded-xl border border-dashed border-gray-300 p-4 text-center text-sm text-gray-500">Noch keine Tasks in dieser Kategorie.</li>`;
      }

      function escapeHtml(str) {
        return (str||'').replace(/[&<>"]/g, (c) => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));
      }

      // ---- 9) Startdaten einmalig einf√ºgen ----
      onAuthStateChanged(auth, async () => {
        const snap = await getDocs(CATS);
        if (snap.empty) {
          const created = {};
          async function makeCat(name) {
            const ref = await addDoc(CATS, { name, createdAt: serverTimestamp() });
            created[name] = ref.id;
          }
          // Kategorien anlegen
          const catNames = [
            "Drogenverkauf",
            "Battlepass",
            "Medic App / Dispatch",
            "Apps / UI",
            "Einreise / Loading Screen",
            "Minijobs",
            "Drogenpflanzen"
          ];
          for (const n of catNames) await makeCat(n);

          // Tasks anlegen (aus deiner Liste)
          const seed = [
            ["Drogenverkauf", "Dealer werden nicht angezeigt", ""],
            ["Drogenverkauf", "Drogenkisten werden nicht in Benson gelegt", ""],
            ["Drogenverkauf", "Nicht alle Sachen werden in Benson gelegt", ""],

            ["Battlepass", "Beim Kauf von Stufen wird kein Geld abgezogen", ""],
            ["Battlepass", "Premium als Item verf√ºgbar machen (Tebex)", ""],

            ["Medic App / Dispatch", "Medic App pr√ºfen/konfigurieren", ""],
            ["Medic App / Dispatch", "Dispatch richtig einstellen", ""],

            ["Apps / UI", "√úberfl√ºssige Apps entfernen", ""],

            ["Einreise / Loading Screen", "Einreise wieder erm√∂glichen", ""],
            ["Einreise / Loading Screen", "Loading Screen reinmachen", ""],

            ["Minijobs", "Minijobs bearbeiten/√ºberarbeiten", ""],

            ["Drogenpflanzen", "Drogenpflanzen verschwinden lassen, wenn man sie abbaut", ""],
          ];
          for (const [cat, title, note] of seed) {
            await addDoc(TASKS, { catId: created[cat], title, note, done: false, createdAt: serverTimestamp() });
          }
        }
      });
    </script>
  </body>
</html>
